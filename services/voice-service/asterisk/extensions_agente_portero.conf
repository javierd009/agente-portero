; =============================================================================
; Agente Portero - Asterisk Dialplan Configuration
; =============================================================================
; INSTALACIÓN:
; 1. Copiar este archivo a /etc/asterisk/extensions_agente_portero.conf
; 2. Agregar esta línea a /etc/asterisk/extensions_custom.conf:
;    #include extensions_agente_portero.conf
; 3. Recargar dialplan: asterisk -rx "dialplan reload"
; =============================================================================

; =============================================================================
; CONFIGURACIÓN SITNOVA
; =============================================================================
; Extensiones:
;   1001 - Tu extensión personal
;   1002 - Teléfono IP Fanvil (Guardia humano / Human-in-the-loop)
;   1004 - Intercomunicador 1
;   1005 - Intercomunicador 2
;   1010 - Agente AI Portero
; =============================================================================

[agente-portero-sitnova]
; Extensión 1010 - Agente AI Portero
; Los intercomunicadores deben configurarse para llamar a esta extensión

exten => 1010,1,NoOp(=== AGENTE PORTERO AI ===)
 same => n,NoOp(Llamada desde: ${CALLERID(num)})
 same => n,Answer()
 same => n,Wait(0.5)
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 ; Configurar tenant y extensión de guardia
 same => n,Set(CHANNEL(tenant_id)=sitnova)
 same => n,Set(CHANNEL(guard_extension)=1002)
 ; Enviar a la aplicación Stasis (Voice Service)
 same => n,Stasis(agente-portero,sitnova)
 same => n,Hangup()

; Ruta alternativa: si el intercom llama directo a la extensión "s"
exten => s,1,NoOp(Llamada entrante de intercom)
 same => n,Goto(agente-portero-sitnova,1010,1)


; =============================================================================
; CONTEXTO PARA INTERCOMUNICADORES
; =============================================================================
; Configurar los intercomunicadores (1004, 1005) para que sus llamadas
; lleguen a este contexto

[from-intercoms-sitnova]
; Cuando el intercom llama, enviar al Agente AI
exten => _X.,1,NoOp(Intercom ${CALLERID(num)} llamando a ${EXTEN})
 same => n,Goto(agente-portero-sitnova,1010,1)

; Si llaman a una extensión específica (1001, 1002), pasar directo
exten => 1001,1,Dial(PJSIP/1001,30)
exten => 1002,1,Dial(PJSIP/1002,30)


; =============================================================================
; CONTEXTO MULTI-TENANT (PARA FUTURO)
; =============================================================================
; Cuando tengas múltiples condominios, agregar contextos similares:
;
; [agente-portero-torres-valle]
; exten => 2010,1,NoOp(Agente AI - Torres del Valle)
;  same => n,Set(CHANNEL(tenant_id)=torres_valle)
;  same => n,Set(CHANNEL(guard_extension)=2002)
;  same => n,Stasis(agente-portero,torres_valle)
;  same => n,Hangup()
;
; [agente-portero-residencial-norte]
; exten => 3010,1,NoOp(Agente AI - Residencial Norte)
;  same => n,Set(CHANNEL(tenant_id)=residencial_norte)
;  same => n,Set(CHANNEL(guard_extension)=3002)
;  same => n,Stasis(agente-portero,residencial_norte)
;  same => n,Hangup()
; =============================================================================


; =============================================================================
; INSTRUCCIONES DE CONFIGURACIÓN EN FREEPBX
; =============================================================================
;
; OPCIÓN 1: Via GUI de FreePBX
; 1. Ir a Applications → Custom Destinations
; 2. Crear destino: agente-portero-sitnova,1010,1
; 3. En los intercomunicadores, configurar que llamen a este destino
;
; OPCIÓN 2: Via extensions_custom.conf
; 1. Agregar este archivo al include
; 2. Configurar los intercomunicadores con contexto: from-intercoms-sitnova
;
; OPCIÓN 3: Via Inbound Routes
; 1. Si los intercoms llaman desde SIP trunk externo
; 2. Crear Inbound Route → Destination: Custom → agente-portero-sitnova,1010,1
; =============================================================================
